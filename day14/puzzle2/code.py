import sys
sys.path.append('../')
sys.path.append('../../')

import re
import math
import pprint

from utils import *

instances = [
    {
        'input': '''\
p=0,4 v=3,-3
p=6,3 v=-1,-3
p=10,3 v=-1,2
p=2,0 v=2,-1
p=0,0 v=1,3
p=3,0 v=-2,-2
p=7,6 v=-1,-3
p=3,0 v=-1,-2
p=9,3 v=2,3
p=7,3 v=-1,2
p=2,4 v=2,-3
p=9,5 v=-3,-3''',
        'bottom_right': (11-1, 7-1),
        'duration_s': 100,
        'robot_count_per_tile': '''\
......2..1.
...........
1..........
.11........
.....1.....
...12......
.1....1....''',
        'total_safety_factor': 12,
        'num_steps_to_easter_egg': 0,
        'adjacency_counts': [],
        'max_count': 0,
        'max_step': -1,
        'max_map_of_robots': "",
    },
    {
        'input': "../puzzle1/input.txt",
        'bottom_right': (101-1, 103-1),
        'duration_s': 100,
        'max_duration_to_easter_egg': 10000
    },
]

attrs = [
    'robot_count_per_tile',
    'total_safety_factor',
    'num_steps_to_easter_egg',
    # 'adjacency_counts',
    'max_count',
    'max_step',
    'max_map_of_robots',
    ]

def solve( instance ):

    strs = get_array_of_strings_from_input( instance['input'] )
    min_x, min_y = 0, 0
    max_x, max_y = instance['bottom_right']

    def parse_strs( strs ):
        robots = []
        for str in strs:
            # p=0,4 v=3,-3
            m = re.match(r"p=([-\d]+),([-\d]+) v=([-\d]+),([-\d]+)", str)
            robot = {
                'id': len(robots),
                'pos': (int(m.group(1)), int(m.group(2))),
                'vel': (int(m.group(3)), int(m.group(4))),
            }
            robots.append( robot )
        return robots

    robots = parse_strs( strs )
    # print( robots )

    def move_robots_by_one_step( robots):
        for robot in robots:
            x = robot['pos'][0] + robot['vel'][0]
            y = robot['pos'][1] + robot['vel'][1]
            if x<min_x or x>max_x:
                x = (x + max_x + 1) % (max_x + 1)
            if y<min_y or y>max_y:
                y = (y + max_y + 1) % (max_y + 1)
            robot['pos'] = (x, y)
        return robots

    for step in range( instance['duration_s'] ):
        robots = move_robots_by_one_step( robots )

    # construct map of robots
    def construct_map_of_robots( robots ):
        int_yx_array = construct_int_yx_array( max_x+1, max_y+1 )
        for robot in robots:
            x, y = robot['pos']
            int_yx_array[y][x] += 1
    
        # convert to str, with '.' for zero, and digit for count
        robot_count_per_tile = ""
        for row in int_yx_array:
            for count in row:
                if count == 0:
                    robot_count_per_tile += "."
                else:
                    robot_count_per_tile += str(count)
            robot_count_per_tile += "\n"

        robot_count_per_tile = robot_count_per_tile.strip()
        return robot_count_per_tile
    
    robot_count_per_tile = construct_map_of_robots( robots )
    # print( robot_count_per_tile )
    # print( robots )

    # count robots in each quadrant
    quadrant_counts = [0, 0, 0, 0]
    for robot in robots:
        x, y = robot['pos']
        if x == max_x/2 or y == max_y/2:
            continue
        x_half = 0 if x < max_x/2 else 1
        y_half = 0 if y < max_y/2 else 1
        quadrant = x_half + 2*y_half
        quadrant_counts[quadrant] += 1

    #  total safety factor is product of counts in each quadrant
    total_safety_factor = math.prod( quadrant_counts )

    def count_adjacent_robots( robots ):
        count = 0
        for r in range(len(robots)-1):
            for s in range(r+1, len(robots)):
                if robots[r]['pos'] == robots[s]['pos']:
                    continue
                if abs(robots[r]['pos'][0] - robots[s]['pos'][0]) <= 1 and abs(robots[r]['pos'][1] - robots[s]['pos'][1]) <= 1:
                    count += 1  
        return count

    def iterate_robots_and_track_adjacencies_from_input( input ):
        strs = get_array_of_strings_from_input( input )
        robots = parse_strs( strs )

        adjacency_counts = []
        max_count = 0
        max_step = -1
        max_map_of_robots = ""
        
        for step in range( instance['max_duration_to_easter_egg'] ):
            robots = move_robots_by_one_step( robots )
            new_adjacency_count = count_adjacent_robots( robots )
            adjacency_counts.append( new_adjacency_count )
            if new_adjacency_count > max_count:
                max_count = new_adjacency_count
                max_step = step
                max_map_of_robots = construct_map_of_robots( robots )
    
        return adjacency_counts, max_count, max_step, max_map_of_robots

    num_steps_to_easter_egg = 0
    max_count = 0
    max_step = -1
    adjacency_counts = []
    max_map_of_robots = ""

    if 'max_duration_to_easter_egg' in instance:
        adjacency_counts, max_count, max_step, max_map_of_robots = iterate_robots_and_track_adjacencies_from_input( instance['input'] )  

    return {
        'robot_count_per_tile': robot_count_per_tile,
        'total_safety_factor': total_safety_factor,
        'num_steps_to_easter_egg': num_steps_to_easter_egg,
        # 'adjacency_counts': adjacency_counts,
        'max_count': max_count,
        'max_step': max_step,
        'max_map_of_robots': max_map_of_robots,
    }

def run():
    print_here()
    verbose = True
    response = exercise_fn_with_cases( solve, instances, attrs, verbose )
    if verbose:
        pprint.pp( response )
    else:
        print( response )

if __name__ == "__main__":
    run()

# AOC 2024: 2024-12-22: day14/puzzle2/..
# [{'robot_count_per_tile': '..................1...1..1..........................................................1...............1\n'
#                           '.......1.......1...1.........................................................1.........11............\n'
#                           '...................1...........................1.............................1..1.....1..............\n'
#                           '1.........................................1..............1.1....................1.................1..\n'
#                           '..................1.....1............................................................................\n'
#                           '....1..1.1...............................1...........................................................\n'
#                           '.........................................................1.............1...1.........................\n'
#                           '.1.....2......1.......1.................1..1.............................1.....1.....................\n'
#                           '...................................................1..1.........1.....1............................1.\n'
#                           '........1............1...............................................................................\n'
#                           '..........1......1.........................................1......1....1.....................1.......\n'
#                           '........................................1.........1....................................1............1\n'
#                           '.......1................1..........1...1......1...........1.....1....................................\n'
#                           '..................................1...................1......................................1.......\n'
#                           '.......1.....1.............................1............1..............1..........1......1.1.........\n'
#                           '.................................................................11....1.........1...................\n'
#                           '.......1..............................................................................1.............1\n'
#                           '..............1...........1.....1........1...............1.....................1.....................\n'
#                           '............1......................1................................1........1...........1...........\n'
#                           '......................1........................1.....................................................\n'
#                           '..........................1..............1..............................1.................1..........\n'
#                           '.................................1...............................1.......................1...........\n'
#                           '.................................................................................1.......1...........\n'
#                           '.1..................1.1.....1.........1.......................................1...................1..\n'
#                           '.................1........1..................................1...1..................1.....1..........\n'
#                           '...............................................1..........11...........11............................\n'
#                           '.....................1....1..............1..............................................1............\n'
#                           '......................1...1......2............................................1..........1...........\n'
#                           '....1...................................................................1...1.............1.......1..\n'
#                           '.......1...........................................................................1.............1...\n'
#                           '..................1............1..................................................1....1............1\n'
#                           '...........1.......1...........11........1..........1..........1.....1.........1................1....\n'
#                           '..........................................1.......1.........1.............1..........................\n'
#                           '....1.........................11.....................................................................\n'
#                           '......1.1............................1...1...........1...............................................\n'
#                           '...........1.............................................1........................1..................\n'
#                           '.1.....1...1...........................1.....................1..................1..................1.\n'
#                           '................................................1..................1.................................\n'
#                           '........................................................1...............1.............11....1........\n'
#                           '........................................................................1......................1.....\n'
#                           '..............1...................1.1................................1...........1...................\n'
#                           '.............1................1........1.......1..........................1.1........................\n'
#                           '.........1.......2............1...........1.......1.1......1..1......1...............................\n'
#                           '........1.......................1.............1............1.........................................\n'
#                           '.1.................1..............1...........................11.........1......1...........2........\n'
#                           '...............................1.................1.......................1.......12.1...............1\n'
#                           '...........11...1...................................................................1..1.............\n'
#                           '.................................1.........................................1..............1..........\n'
#                           '..........1......1.....1...1..................1....1.............1........1..............1...........\n'
#                           '..1.....1..............1.....1......1.......................1..............1.........................\n'
#                           '............................1..1....................1..........1......1...................1..........\n'
#                           '..............1............................................................................1....1....\n'
#                           '.....1...................................................1..1......1.................................\n'
#                           '..............................................................................................11.....\n'
#                           '.....................................................................................................\n'
#                           '..........1....................2...........................1.....................1...................\n'
#                           '.............................................1...........1................1.....1....................\n'
#                           '......1................1.....1................1....................1...........................1.....\n'
#                           '...................1...........................1.....................................................\n'
#                           '.....................................................................................................\n'
#                           '.1...................................................................................................\n'
#                           '........1..................................1...............1...........1..................1..........\n'
#                           '.................................1...................................................................\n'
#                           '1.........1........1.............1.......................1.......1..............1....................\n'
#                           '.......1..1.........1...11...........1..1........1..1...1...1..........1.............................\n'
#                           '...11........................................1...........1............1........1......1..............\n'
#                           '..............................1..........................................1..................1...11...\n'
#                           '1...1......211...............1.......................................................................\n'
#                           '1.......................................1................................1..........1............1...\n'
#                           '..........11..........1..............1............1.1........................................1.......\n'
#                           '1............................................1............1...................1......................\n'
#                           '..........................................................1......1...................................\n'
#                           '............................................1....11..................................................\n'
#                           '........1..........................................1......1...............................1..........\n'
#                           '.1.....................................................1....1........................................\n'
#                           '..........1............1..............1.......................................1......................\n'
#                           '.................1..1......................11......1........1........................................\n'
#                           '.....1...............................1...................1............1.........................1....\n'
#                           '....................1....................................11..............................1.......1...\n'
#                           '1................................................................................1...................\n'
#                           '....1.........................................................................1.1.................1..\n'
#                           '.......................1.............1....................1....1..................1....1.......1.....\n'
#                           '............................1............1....1......1.................1...........1.................\n'
#                           '.............1......................................................1................................\n'
#                           '.......1..1..................................................1..........................1..1...1.....\n'
#                           '...................................................1....1....1..................1....................\n'
#                           '.....................1...1.....1..1......1.......1.......1....................................1......\n'
#                           '.......................1........11..............1.11...........................................1.....\n'
#                           '........................11.........1....................1...........1...............1.....1..........\n'
#                           '................1..........1.....1..................................................1.....1..........\n'
#                           '...1................................................1........................................1.......\n'
#                           '........1..........1...1.............1..1.........................1..................................\n'
#                           '..........1.......................1..............................................1......1...........1\n'
#                           '......1.........................................................1.......................1............\n'
#                           '....................1..................................................1...........1...1.1...........\n'
#                           '................................................................1............1.......................\n'
#                           '...................................1.....1.........................1.................................\n'
#                           '...........1.....1.....1........................................................1................1...\n'
#                           '........................1..............1..1...................1.......1.................1..1.......1.\n'
#                           '......................................11...................1............1.........1..................\n'
#                           '......................................1........2.................2...............11....1..........1..\n'
#                           '.1.....1...................................1.....1..........................1...1...................1\n'
#                           '.................1..............................................1.....................1............1.',
#   'total_safety_factor': 225810288,
#   'num_steps_to_easter_egg': 0,
#   'max_count': 928,
#   'max_step': 6751,
#   'max_map_of_robots': '................................1...............................................................1....\n'
#                        '.......................................................1...............1.................1.....1.....\n'
#                        '.1.........................................................................................1.........\n'
#                        '..........................................................................1..........................\n'
#                        '..............................................................1......................................\n'
#                        '...............................1......1........................1.....................................\n'
#                        '.................1....................1.........................................1....................\n'
#                        '.......................1.............................................................................\n'
#                        '................1..................1........................1........................................\n'
#                        '......1..............................................................................1...............\n'
#                        '............................................................................1........................\n'
#                        '.................................................................................................1...\n'
#                        '..................1....................11................................1...........................\n'
#                        '...............1...........................................1...................1.....................\n'
#                        '....................................................................................................1\n'
#                        '....................1................................................................................\n'
#                        '.............................................................1.......................................\n'
#                        '.....................................................................................................\n'
#                        '......................................1............................1.................................\n'
#                        '................................................1....................................................\n'
#                        '.................................................................1..........1........1...........1...\n'
#                        '..............................................1......................................................\n'
#                        '.....................................................................................................\n'
#                        '..1......................................1.....................1.............1.......................\n'
#                        '.....................................................................................................\n'
#                        '....1..............................1...............1....1............................................\n'
#                        '.............................................1...........1...........................................\n'
#                        '..............................................................................................1......\n'
#                        '..............................................................1.....1................................\n'
#                        '.......1.............................................................................................\n'
#                        '.....................................................................................................\n'
#                        '...............1.....................................................................................\n'
#                        '..................................1..........1.......................................................\n'
#                        '...........................................................1.........................................\n'
#                        '...................................................................1.................................\n'
#                        '................................................................................1....................\n'
#                        '...................................................................................................1.\n'
#                        '.............................................1111111111111111111111111111111.........................\n'
#                        '.............................................1.............................1.........................\n'
#                        '.............................................1.............................1..1......................\n'
#                        '.............................................1.............................1........................1\n'
#                        '........................1....................1.............................1.........................\n'
#                        '.......1....1.......1...1....................1..............1..............1....1....................\n'
#                        '1............................................1.............111.............1....................1....\n'
#                        '.....................1.......1...............1............11111............1.........................\n'
#                        '.......1.....................................1...........1111111...........1.........................\n'
#                        '................1...................1........1..........111111111..........1.........................\n'
#                        '.............................................1............11111............1.......................1.\n'
#                        '.............................................1...........1111111...........1.........................\n'
#                        '.............................................1..........111111111..........1...................1.....\n'
#                        '...............1.............................1.........11111111111.........1.........................\n'
#                        '.......1.....................................1........1111111111111........1..............1..........\n'
#                        '.............................................1..........111111111..........1....1....................\n'
#                        '..1...................1.............1........1.........11111111111.........1.........................\n'
#                        '....1........................................1........1111111111111........1.........................\n'
#                        '.............................................1.......111111111111111.......1.........................\n'
#                        '.............................................1......11111111111111111......1.........................\n'
#                        '.............................................1........1111111111111........1.........................\n'
#                        '...................1................1........1.......111111111111111.......1....1....................\n'
#                        '.............................................1......11111111111111111......1....................1....\n'
#                        '...1.........................................1.....1111111111111111111.....1.........................\n'
#                        '.............................................1....111111111111111111111....1....1....................\n'
#                        '.....1.......................................1.............111.............1.........................\n'
#                        '.............................................1.............111.............1.........................\n'
#                        '.............................................1.............111.............1.........................\n'
#                        '.............................................1.............................1.........................\n'
#                        '.............................................1.............................1.........................\n'
#                        '....................1........................1.............................1.........................\n'
#                        '....................1....1..........1........1.............................1.1.......................\n'
#                        '...................1.........................1111111111111111111111111111111.........1...............\n'
#                        '.....................................................................................................\n'
#                        '....1.....................................1.............................1............................\n'
#                        '.......................................1.............................................................\n'
#                        '......................................1.......................1......................................\n'
#                        '....................................................................................1................\n'
#                        '...............1.....................................................................................\n'
#                        '.................................................................................................1...\n'
#                        '..................................................................................1..................\n'
#                        '.....................................................................................................\n'
#                        '.....................................................................................................\n'
#                        '.....................................................................................................\n'
#                        '.............................................1.....1.................................................\n'
#                        '...................................................................1........1.....1..................\n'
#                        '.........1..................................1..1.................1...................................\n'
#                        '......1.................................1...........................1................................\n'
#                        '........................................................................1.........................1..\n'
#                        '.....................................................................................................\n'
#                        '................................1........................1...........................................\n'
#                        '.................................................................1..........1........................\n'
#                        '.................1..............1...................1................................................\n'
#                        '.....................................................................................................\n'
#                        '.....................................................................................................\n'
#                        '.....................................................................................................\n'
#                        '..................................................................1.................1................\n'
#                        '.....................................................................................................\n'
#                        '.............................................1.......................................................\n'
#                        '.....................................................1........................1......................\n'
#                        '..............1......................................................................................\n'
#                        '..............................1........................1...........................1.................\n'
#                        '.........................1...........................................................................\n'
#                        '.....................................................................................................\n'
#                        '.........................................................................................1...........\n'
#                        '...................................................................1...11............................'}]
# NB: add 1 to the max_step to get the correct answer as the number of seconds.